name: Backend CI/CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. 소스코드 체크아웃
      - name: Checkout source
        uses: actions/checkout@v3
        with:
          ref: main
          fetch-depth: 0

      # 2. JDK 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 3. Gradle 실행 권한 부여
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. Gradle 빌드 (테스트 제외)
      - name: Build with Gradle (skip tests)
        run: ./gradlew clean build -x test

      # 5. 로컬 빌드 결과 확인
      - name: Debug – list local build/libs
        run: ls -lh build/libs

      # 6. 빌드된 JAR 업로드 (plain.jar 제외)
      - name: Upload JAR as artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-jar
          path: |
            build/libs/*-SNAPSHOT.jar
            !build/libs/*plain.jar
          retention-days: 3

      # 7. EC2 디렉토리 준비
      - name: Prepare remote dirs
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            mkdir -p /home/${USER}/deploy_artifacts/build/libs
            sudo mkdir -p /opt/carrot
            sudo chown -R ${USER}:${USER} /home/${USER}/deploy_artifacts
            sudo chown -R ${USER}:${USER} /opt/carrot

      # 8. 빌드된 JAR 파일 EC2로 전송
      - name: Upload JAR to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "build/libs/*-SNAPSHOT.jar"
          target: "/home/ubuntu/deploy_artifacts/build/libs/"
          overwrite: true

      # 9. 원격 전송 확인
      - name: Verify remote staging
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "[REMOTE] staging list:"
            ls -lh /home/${USER}/deploy_artifacts/build/libs

      # 10. /opt/carrot/app.jar 교체 & .env 파일 생성
      - name: Promote to /opt/carrot/app.jar and write .env
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            cd /home/${USER}/deploy_artifacts/build/libs

            # 최신 생성된 JAR 선택
            LATEST_JAR=$(ls -Art *-SNAPSHOT.jar | grep -v 'plain' | tail -n 1)
            echo "[PROMOTE] Using $LATEST_JAR"

            # 기존 JAR 삭제 후 새 JAR 복사
            sudo rm -f /opt/carrot/app.jar
            sudo cp "$LATEST_JAR" /opt/carrot/app.jar
            sudo chown ${USER}:${USER} /opt/carrot/app.jar
            ls -lh /opt/carrot/app.jar

            # 배포된 JAR에 TestApi.class 있는지 확인
            echo "[CHECK] Searching for TestApi.class in deployed jar..."
            jar tf /opt/carrot/app.jar | grep "TestApi.class" || (echo "❌ TestApi.class not found" && exit 1)

            # 환경변수 파일 작성
            sudo bash -c 'cat > /opt/carrot/.env <<EOT
            SPRING_PROFILES_ACTIVE=prod
            SERVER_PORT=8080
            SPRING_DATASOURCE_URL=${{ secrets.DB_URL }}
            SPRING_DATASOURCE_USERNAME=${{ secrets.DB_USERNAME }}
            SPRING_DATASOURCE_PASSWORD=${{ secrets.DB_PASSWORD }}
            CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
            EOT'
            sudo chmod 600 /opt/carrot/.env
            sudo sed -i "s/\r$//" /opt/carrot/.env
        

        # 11. JAR 내용 검증
      - name: Validate deployed JAR contents
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            echo "[VALIDATE] Checking if TestApi.class exists in deployed jar..."
            jar tf /opt/carrot/app.jar | grep -q "TestApi.class" && echo "✅ TestApi found" || (echo "❌ TestApi NOT found" && exit 1)

        # 12. 서비스 재시작
      - name: Restart Spring Boot on EC2
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            sudo systemctl daemon-reload
            sudo systemctl restart carrot
            sudo systemctl status carrot --no-pager
